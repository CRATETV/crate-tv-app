<?xml version="1.0" encoding="utf-8" ?>
<component name="StatusTask" extends="Task">
    <interface>
        <field id="isLinked" type="boolean" value="false" />
    </interface>
    <script type="text/brightscript">
        <![CDATA[
        sub init()
            m.top.functionName = "checkLinkStatus"
        end sub

        sub checkLinkStatus()
            ' 1. Get Device ID
            di = CreateObject("roDeviceInfo")
            uuid = di.GetChannelClientId()
            
            ' 2. Check Status Endpoint
            url = "https://cratetv.net/api/check-roku-link-status?deviceId=" + uuid
            
            request = CreateObject("roUrlTransfer")
            request.SetCertificatesFile("common:/certs/ca-bundle.crt")
            request.InitClientCertificates()
            request.SetUrl(url)
            request.AddHeader("User-Agent", "Roku/CrateTV")
            request.RetainBodyOnError(true)

            response = request.GetToString()
            
            if response <> ""
                json = ParseJson(response)
                if json <> invalid
                    ' Check for various success flags common in APIs
                    if json.linked = true or json.status = "linked" or json.success = true
                        m.top.isLinked = true
                    end if
                end if
            end if
        end sub
        ]]>
    </script>
</component>
